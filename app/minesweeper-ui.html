<!DOCTYPE html>

<html>

<head>
	<title>Minesweeper</title>
	<meta charset="utf-8">
	<style>
		* {
			margin: 0;
		}
		html,
		body {
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		canvas {
			display: block;
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
		}
	</style>
    
</head>

<body style="background-color:black;">

<script type="module">

import kaboom from "https://unpkg.com/kaboom/dist/kaboom.mjs";

const windowWidth = document.documentElement.clientWidth
const windowHeight = document.documentElement.clientHeight
const gameWidth = 1200
const gameHeight = 700
const scaleX = windowWidth / gameWidth
const scaleY = windowHeight / gameHeight 
const scaleGame = Math.min(scaleX, scaleY)

async function getState() {
        const response = await fetch('/apps/minesweeper/state')
        return response.json()
    }
var state = await getState()
var width = state[0]
var height = state[1]
var mines = state[2]
var reveals = state[3]
var win = state[4]
var lose = state[5]
var grid = state[6]

async function post(tag, data) {
    const response = await fetch('/apps/minesweeper', {
        method: 'POST',
        body: JSON.stringify({[tag]: data})
    })

    state = await response.json()
    width = await state[0]
    height = await state[1]
    mines = await state[2]
    reveals = await state[3]
    win = await state[4]
    lose = await state[5]
    grid = await state[6]

    await go("minesweeper")
}

kaboom({
    width: 1200,
    height: 700,
    scale: scaleGame,
    background: [255, 255, 255]
})

var topBuffer = 20
var leftBuffer = 20
var topGridBuffer = topBuffer + 10
var leftGridBuffer = leftBuffer + 10

var tileSize = 20
var tileSpace = tileSize + 2

function drawGrid()
{
  onDraw(() => {
    drawRect({
      pos: vec2(leftBuffer, topBuffer),
      width: tileSpace * width + leftBuffer,
      height: tileSpace * height + topBuffer,
      color: rgb(240, 240, 240),
      radius: 3,
      outline: {width: 1, color: rgb(0, 0, 0)}
    })

    for(var j = 0; j < height; j++) 
      for(var i = 0; i < width; i++) 
        drawTile(leftGridBuffer + i * tileSpace, topGridBuffer + j * tileSpace, grid[j*width + i])
  })
}

function drawTile(x, y, tile)
{
    var revealed = tile[0]
    var flagged = tile[1]
    var mine = tile[2]
    var neighbors = tile[3]
    
    var tileColor = rgb(190, 190, 190)
    if(mousePos().x > x && mousePos().x < x + tileSize && mousePos().y > y && mousePos().y < y + tileSize && isMouseDown())
      tileColor = rgb(250, 250, 250)
    if(flagged == 1)
      tileColor = rgb(150, 50, 50)
    if(lose == 1 && mine == 1)
      tileColor = rgb(0, 0, 0)

    if(revealed == 0 || mine == 1)
    {
        drawRect({
          pos: vec2(x, y),
          width: tileSize,
          height: tileSize,
          color: tileColor,
          outline: {width: 1, color: rgb(0, 0, 0)}
        })
    }
    if(revealed == 1 && neighbors > 0 && mine == 0)
    {
        drawText({
            text: neighbors,
            font: "sink",
            pos: vec2(x + tileSize/2, y + tileSize/2),
            origin: "center",
            size: tileSize*.8,
            color: rgb(0, 0, 0)
        })
    }
}

function getTileFromMouse() {
  var x = Math.floor((mousePos().x - leftGridBuffer)/tileSpace)
  var y = Math.floor((mousePos().y - topGridBuffer)/tileSpace)

  console.log(x)
  console.log(y)

  return [x, y]
}

function mouseOnGrid() {
  if(mousePos().x > leftGridBuffer && mousePos().x < (leftGridBuffer + width*tileSpace))
    if(mousePos().y > topGridBuffer && mousePos().y < (topGridBuffer + height*tileSpace))
      return 1
  
  return 0
}

scene("minesweeper", () => {
    console.log(state)
    console.log(lose)

    layers([
        "default",
    ], "default")

    drawGrid()

    onMousePress(() => {
      if(mouseOnGrid())
        post("guess", getTileFromMouse())
    })
    onMousePress("right", () => {
      if(mouseOnGrid())
        post("flag", getTileFromMouse())
    })
    
    onKeyPress("space", () => {
		  post("new-game", [7, 7, 10])
	  })
})

go("minesweeper")


</script>

</body>

</html>
